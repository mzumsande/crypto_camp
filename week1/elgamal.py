import random
from fast_exp import *

#x: secret key, p prime, g generator, k ephemeral key, x secret key, m message
def calc_pubkey(x, p, g):
    return fast_exp(g, x, p)

def elgamal_enc(m, pub, p, g, k):
    assert(m > 1 and m < p)
    c1 = fast_exp(g, k, p)
    c2 = m * fast_exp(pub, k, p) % p
    return c1, c2

def elgamal_dec(c1, c2, x, p):
    x = fast_exp(c1, x, p)
    x_inv = inv_mult(x, p)
    return c2 * x_inv % p


def test_el_gamal(p, g, x, k, m, c1, c2):
    pubkey = calc_pubkey(x, p, g)
    c1_calc, c2_calc = elgamal_enc(m, pubkey, p, g, k)
    assert c1_calc == c1
    assert c2_calc == c2
    m_calc = elgamal_dec(c1, c2, x, p)
    assert m_calc == m

#Test vectors
# p,g,x,k,m,c1,c2
#from book
test_el_gamal(467, 2, 153, 197, 331, 87, 57)
#from forum
test_el_gamal(71, 33, 62, 31, 15, 62, 18)
test_el_gamal(23,11,6,3,10,20,22)
test_el_gamal(809,3,68,89,100,345,517)
test_el_gamal(17,6,5,10,13,15,9)
test_el_gamal(84265675725482892459719348378630146162719620409152809167814480007059199482163, \
    5,\
    2799014790424892046701478888900891009403869701173893426,\
    23517683968368899022119256606644551548285683288848885921,\
    87521618088882658227876453,\
    22954586883013884818653063688294540134886732496160582262267014428782771199687,\
    56046128113101346099694619669629128017849277484825379502821514323706183544424)
test_el_gamal(12658517083168187407924345155971956101250996576825115113297001855799796437288935576230034157578333666497170430505565580165565829633685607504706642034926119,\
    7,\
    2001688878140630728014209681954697141876038523595247208,\
    5446024688717452254835115775456957961297236108858862823,\
    87521618088882658227876453,\
    2150519483988769855483983776372336742288374425191291528256965705108393490638750082340115568718132372731853110762124400441550538499580316268601341087676203,\
    1540471266850557563382406324432354117072109094950140952195099581066490559252112349492583688225692526496193879919152401794896907007394565292272866724291488)
